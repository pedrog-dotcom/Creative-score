name: Creative Score Pipeline V2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 1'

env:
  META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
  META_AD_ACCOUNT_ID: ${{ secrets.META_AD_ACCOUNT_ID }}
  META_GRAPH_VERSION: "v24.0"
  AI_API_KEY: ${{ secrets.AI_API_KEY }}
  AI_MODEL: ${{ secrets.AI_MODEL || 'gpt-4o' }}
  AI_ENDPOINT_URL: ""
  AI_TIMEOUT_SECONDS: "180"
  AI_MAX_FRAMES: "8"

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pandas requests python-dotenv facebook-business moviepy pillow

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            creatives_output/
            history/
          key: creative-score-cache-${{ github.run_number }}
          restore-keys: |
            creative-score-cache-

      - name: Download creatives
        run: |
          echo "=== PASSO 1: Download de Criativos ==="
          python download_creatives.py

      - name: Run performance score
        run: |
          echo "=== PASSO 2: Calcular Performance Score ==="
          python "Performance Score.py"

      - name: Consolidate data
        run: |
          echo "=== PASSO 3: Consolidando dados ==="
          python consolidate_data.py

      - name: AI analyze creatives
        run: |
          echo "=== PASSO 4: Analise de IA ==="
          python ai_analyze_creatives.py

      - name: Generate qualitative report
        run: |
          echo "=== PASSO 5: Gerando Relatorio Qualitativo ==="
          python generate_qualitative_report.py || echo "Relatorio qualitativo nao gerado"

      - name: Update playbook
        run: |
          echo "=== PASSO 6: Atualizando Playbook ==="
          python update_playbook.py

      - name: Commit and push results
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A history/ || true
          git add -A creatives_output/ || true
          git add creative_score_automation.csv || true
          git add summary_email.txt || true
          git add *.log || true
          if git diff --staged --quiet; then
            echo "Nenhuma mudanca para commitar"
          else
            git commit -m "chore: Atualiza scores e analises - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: creative-score-results-${{ github.run_number }}
          path: |
            creative_score_automation.csv
            summary_email.txt
            creatives_output/consolidated_data.json
            creatives_output/analysis/
            creatives_output/creative_playbook.md
            history/
          retention-days: 30
